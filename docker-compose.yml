services:
  # KVStore Manager (cluster coordinator)
  kvstore-manager:
    image: kvstore:latest
    container_name: kvstore-manager
    command: ["manager", "-config", "cluster.docker.json"]
    depends_on:
      - kvstore-node1
    ports:
      - "8080:8080"   # HTTP API
      - "6060:6060"   # pprof
    volumes:
      - ./cluster.docker.json:/home/kvstore/cluster.docker.json:ro
    networks:
      - kvstore-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # KVStore Node 1 (builds the image)
  kvstore-node1:
    build:
      context: .
      dockerfile: Dockerfile
    image: kvstore:latest
    container_name: kvstore-node1
    command: ["node", "-id", "1", "-config", "cluster.docker.json"]
    ports:
      - "9001:9001"   # HTTP API (host:container)
      - "8001:8001"   # RPC
      - "6061:6060"   # pprof
    volumes:
      - ./cluster.docker.json:/home/kvstore/cluster.docker.json:ro
    networks:
      - kvstore-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # KVStore Node 2 (reuses the image)
  kvstore-node2:
    image: kvstore:latest
    container_name: kvstore-node2
    command: ["node", "-id", "2", "-config", "cluster.docker.json"]
    depends_on:
      - kvstore-node1
    ports:
      - "9002:9001"   # HTTP API (host:container)
      - "8002:8001"   # RPC
      - "6062:6060"   # pprof
    volumes:
      - ./cluster.docker.json:/home/kvstore/cluster.docker.json:ro
    networks:
      - kvstore-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # KVStore Node 3 (reuses the image)
  kvstore-node3:
    image: kvstore:latest
    container_name: kvstore-node3
    command: ["node", "-id", "3", "-config", "cluster.docker.json"]
    depends_on:
      - kvstore-node1
    ports:
      - "9003:9001"   # HTTP API (host:container)
      - "8003:8001"   # RPC
      - "6063:6060"   # pprof
    volumes:
      - ./cluster.docker.json:/home/kvstore/cluster.docker.json:ro
    networks:
      - kvstore-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  kvstore-network:
    driver: bridge

